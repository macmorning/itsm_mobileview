<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<!-- Uncomment if using offline libraries
	<link rel="stylesheet" href="lib/jquery.mobile-1.2.0.min.css" />
	<script src="lib/jquery-1.8.2.min.js"></script>
	<script src="lib/jquery.mobile-1.2.0.min.js"></script>
	<script type="text/javascript" src="lib/modernizr-latest.js"></script>
	-->
	<!-- Comment if using offline libraries -->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
	<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
	<script type="text/javascript" src="http://www.modernizr.com/downloads/modernizr-latest.js"></script>
	<!-- -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="itsm_mobileview-0.1.js"></script>
	<script>
	if ( ! window.console ) console = { log: function(){} };
	var localStorageCredentials = "ITSMMobileContextCredentials";
	var localStorageUserInfo = "ITSMMobileContextUserInfo";
	var localStorageCounters = "ITSMMobileContextCounters";
	;CONTEXT = {
		credentials: {
			server:"",
			username:"",
			password:""
		},
		userinfo: {
			fullname:"",
			license_type:"",
			email:"",
			groups:""
		},
		counters: {
			countIncidents:0,
			countChanges:0,
			countTasks:0,
			countApprovals:0,
		},
		incidents : {},
		changes : {},
		tasks : {},
		approvals : {}
	}
	
	
	function showIncident(id)
	{
		$('#incident_id').text(CONTEXT.incidents[id].number);
		$('#incident_summary').val(CONTEXT.incidents[id].summary);
		$('#incident_priority').val(CONTEXT.incidents[id].priority);
		$('#incident_status').val(CONTEXT.incidents[id].status);
		$('#incident_assignedSG').val(CONTEXT.incidents[id].assignedSG);
		ITSM_MOBILEVIEW.getList(
			CONTEXT.credentials,
			'HPD_IncidentInterface_WS',
			'HelpDesk_GetWorkInfoList',
			'\'Incident Number\'="' + id + '"',
			function(request,status)
			{
				$(request).find("ns0\\:getListValues").each(function()
				{
					return false; // to be completed
				});
			},
			function(request,status,error)
			{
				$.mobile.loading('hide');
				alert("error : " + error);
			}
		);
		$.mobile.changePage($("#incidentpage"));
		return true;
	}
	function listIncidents()
	{
		console.log('listIncidents called');
		$.mobile.loading('show');
		CONTEXT.incidents = {}; // init the incidents array
		ITSM_MOBILEVIEW.getList(
				CONTEXT.credentials,
				'HPD_IncidentInterface_WS',
				'HelpDesk_QueryList_Service',
				'\'Assignee Login ID\'="' + CONTEXT.credentials.username + '" AND \'Status\'&lt;5',
				function(request,status)
				{
					$(request).find("ns0\\:getListValues").each(function()
					{
						var id = $(this).find("ns0\\:Incident_Number").text(); // get the incident number; will be used as a key for the context.incidents array
						CONTEXT.incidents[id] = 
												{
													number : id,
													status : $(this).find("ns0\\:Status").text(),
													statusReason : $(this).find("ns0\\:Status_Reason").text(),
													serviceType : $(this).find("ns0\\:Service_Type").text(),
													assignedSGCompany : $(this).find("ns0\\:Assigned_Support_Company").text(),
													assignedSGOrganization : $(this).find("ns0\\:Assigned_Support_Organization").text(),
													assignedSG : $(this).find("ns0\\:Assigned_Group").text(),
													summary : $(this).find("ns0\\:Summary").text(),
													priority : $(this).find("ns0\\:Priority").text(),
													categorization1 : $(this).find("ns0\\:Categorization_Tier_1").text(),
													categorization2 : $(this).find("ns0\\:Categorization_Tier_2").text(),
													categorization3 : $(this).find("ns0\\:Categorization_Tier_3").text(),
													firstName : $(this).find("ns0\\:First_Name").text(),
													lastName : $(this).find("ns0\\:Last_Name").text(),
													vip : $(this).find("ns0\\:VIP").text(),
													phone : $(this).find("ns0\\:Phone_Number").text(),
													email : $(this).find("ns0\\:Internet_E-mail").text(),
													region : $(this).find("ns0\\:Region").text(),
													site : $(this).find("ns0\\:Site").text(),
													reportedDate : $(this).find("ns0\\:Reported_Date").text(),
													submitDate : $(this).find("ns0\\:Submit_Date").text()
												};
						$("#incidentslist").append('\
							<li>\
								<a href="#" onclick="showIncident(\'' + id + '\')">\
									<h1>' + id + ' - ' + CONTEXT.incidents[id].priority + '</h1>\
									<p><b>' + CONTEXT.incidents[id].status + "</b><br/>" +
									CONTEXT.incidents[id].summary + '</p>\
								</a>\
							</li>');
					});
					$.mobile.loading('hide');
					$.mobile.changePage($("#incidentspage"));
					$("#incidentslist").trigger('create');
				},
				function(request,status,error)
				{
					$.mobile.loading('hide');
					alert("error : " + error);
				}
		);
	}

	$(document).ready(function() {
			// check if the browser can use localStorage
			if (!Modernizr.localstorage) {
				alert("Your browser cannot run this application.");
				return false;
			}
			// When user clicks "submit", get user's information via the getList function in the ITSM_MOBILEVIEW namespace
			$("#login_submit").click(function(event) {
				event.preventDefault();
				CONTEXT.credentials = { server: $('#login_server').val(), username: $('#login_username').val(), password: $('#login_password').val() };
				//localStorage.setItem(localStorageCredentials,JSON.stringify(CONTEXT.credentials));
				$.mobile.loading('show');
				ITSM_MOBILEVIEW.callService(
					CONTEXT.credentials,
					'Connect',
					function(xml){			// on successful login, get userinfo and switch to homepage
							CONTEXT.userinfo = ITSM_MOBILEVIEW.extractUserInfo(xml);
							CONTEXT.counters = ITSM_MOBILEVIEW.extractCounters(xml);
							$("#homeName").html(CONTEXT.userinfo["fullname"]);
							$("#incidentscount").text(CONTEXT.counters["countIncidents"]);
							$("#changescount").text(CONTEXT.counters["countChanges"]);
							$("#taskscount").text(CONTEXT.counters["countTasks"]);
							$("#approvalscount").text(CONTEXT.counters["countApprovals"]);
							$.mobile.changePage($("#homepage"));
							$.mobile.loading('hide');
							//localStorage.setItem(localStorageUserInfo,JSON.stringify(CONTEXT.userinfo));
							//localStorage.setItem(localStorageCounters,JSON.stringify(CONTEXT.counters));
					},
					function(error){		// on error, show error and stop
							$.mobile.loading('hide');
							alert("Authentication error" + eval(error));
					}
				);
			});
		});
	</script>
</head>
<body>
<!--############### Login Page ###############-->
<div data-role="page" id="loginpage"> <!-- identification -->
	<header data-role="header">
		<h1>Login</h1>
	</header>
	<form method="POST" action="" data-ajax="false">
		<label for="login_server">Server:</label>
		<input type="text" name="login_server" id="login_server"/>
		<label for="login_username">Username:</label>
		<input type="text" name="login_username" id="login_username" />
		<label for="login_password">Password:</label>
		<input type="password" name="login_password" id="login_password" />
		<button id="login_submit" type="submit" data-theme="a">Submit</button>
	</form>	
</div>

<!--############### Home Page ###############-->
<div data-role="page" id="homepage"> 
	<header data-role="header">
		<h1>ITSM Mobile Home</h1>
		<a href="#loginpage" data-icon="delete" data-iconpos="notext">Exit</a>
		<a href="#configpage" data-icon="gear" data-iconpos="notext">Configuration</a>
	</header>
	<p style="text-align:center;" id="homeName"></p>
	<ul data-role="listview">
		<li><a href="#" onclick="listIncidents()">Incidents <span id="incidentscount" class="ui-li-count"></span></a></li>
		<li><a href="#changespage">Changes <span id="changescount" class="ui-li-count"></span></a></li>
		<li><a href="#taskspage">Tasks <span id="taskscount" class="ui-li-count"></span></a></li>
		<li><a href="#approvalspages">Approvals <span id="approvalscount" class="ui-li-count"></span></a></li>
	</ul>
</div>

<!--############### Incidents ###############-->
<div data-role="page" id="incidentspage">
	<header data-role="header">
		<h1>Incidents</h1>
		<a href="#homepage" data-icon="back" data-iconpos="notext">Previous</a>
	</header>
	<article data-role="content">
		<ul data-role="listview" data-filter="true" id="incidentslist">
			<!-- incidents come here in <li> elements -->
		</ul>
	</article>
	<footer data-role="footer" data-position="fixed">
		<nav data-role="navbar">
			<ul>
				<li><a href="#homepage" data-icon="home" data-iconpos="notext">Home</a></li>
				<li><a href="#" data-icon="info">Info</a></li>
				<li><a href="#" onclick="listIncidents()" data-icon="refresh">Refresh</a></li>				
			</ul>
		</nav>
	</footer>
</div>

<!--############### Incident Detail ###############-->
<div data-role="page" id="incidentpage">
	<header data-role="header">
		<h1 id="incident_id">Incident Detail</h1>
		<a href="#incidentspage" data-icon="back" data-iconpos="notext">Previous</a>
		<a href="#" data-icon="save" data-iconpos="notext">Save</a>
	</header>
	<form method="POST" action="" data-ajax="false">
		<label for="incident_priority">Priority:</label>
		<input type="text" name="incident_priority" id="incident_priority" />
		<label for="incident_status">Status:</label>
		<input type="text" name="incident_status" id="incident_status" />
		<label for="incident_assignedSG">Assigned group:</label>
		<input type="text" name="incident_assignedSG" id="incident_assignedSG" />
		<label for="incident_summary">Summary:</label>
		<textarea rows="3" name="incident_summary" id="incident_summary"/>
	</form>	
	<footer data-role="footer" data-position="fixed">
		<nav data-role="navbar">
			<ul>
				<li><a href="#homepage" data-icon="home" data-iconpos="notext">Home</a></li>
				<li><a href="#" data-icon="info">Info</a></li>
				<li><a href="#" data-icon=""></a></li>				
			</ul>
		</nav>
	</footer>
</div>
</body>
</html>